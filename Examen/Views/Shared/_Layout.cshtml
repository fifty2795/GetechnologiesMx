@using System.Security.Claims;

@{
    Layout = null;
    var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
    var nombreUsuario = User.Identity.Name;
    var fotoUrl = Url.Content("/images/avatar-default.jpg");
    var tmp = "";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Moderno</title>

    <script>
        // Aplica el tema antes de que el contenido sea visible
        (function () {
            try {
                if (localStorage.getItem("theme") === "dark") {
                    document.documentElement.classList.add("dark-mode");
                }
            } catch (e) { }
        })();

        // Aplica collapsed a la barra lateral antes de que el contenido sea visible
        (function () {
            const isCollapsed = localStorage.getItem("sidebar-collapsed") === "true";
            if (isCollapsed) {
                document.addEventListener("DOMContentLoaded", () => {
                    const sidebar = document.querySelector(".sidebar");
                    if (sidebar) {
                        sidebar.classList.add("collapsed");
                    }
                });
            }
        })();
    </script>

    @* Estilos *@
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css" />
    <link rel="stylesheet" href="@Url.Content("~/css/dashboard-custom.css")" />
    <link rel="stylesheet" href="@Url.Content("~/css/Estilos.css")" />

    <link rel="icon" type="image/png" href="~/images/logo.png">

    @RenderSection("Styles", required: false)

</head>

<body class="@(Context.Request.Cookies["theme"] == "dark" ? "dark-mode" : "")" data-theme="@Context.Request.Cookies["theme"]">

    <div id="loading" style="display:none;">
        <img src="~/gif/loading.gif" alt="Loading...">
    </div>

    @if (isAuthenticated)
    {
        <div id="dashboard-container">
            <aside class="sidebar">
                <div class="sidebar-header d-flex align-items-center justify-content-center py-3">
                    <img src="~/images/logo.png" alt="Logo" class="logo-img me-2">
                    <h2 class="brand-title text-white m-0">Examen API</h2>
                </div>
                <div class="bg-user-banner">
                    <img src="~/images/tmp.webp" alt="Fondo Usuario" class="bg-user-img">
                    <h2 class="userName-title text-white m-0 d-flex flex-column align-items-center">
                        <img src="@fotoUrl"
                             alt="Usuario"
                             class="user-profile-img me-2">
                        <b class="userName-perfil">@nombreUsuario</b>
                    </h2>
                </div>

                <nav class="menu d-flex flex-column align-items-center py-4">

                    @* Personas *@

                    <div class="menu-group">
                        <button class="menu-toggle">
                            <i class="fas fa-user me-2"></i>
                            Personas
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <div class="submenu">
                            <a asp-controller="Persona" asp-action="Index"><i class="fas fa-list"></i>Ver Todos</a>
                            <a asp-controller="Persona" asp-action="AgregarPersona"><i class="fas fa-plus-circle"></i>Agregar Nuevo</a>
                        </div>
                    </div>

                    @* Facturas *@

                    <div class="menu-group">
                        <button class="menu-toggle">
                            <i class="fas fa-file-invoice me-2"></i>
                            Facturas
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <div class="submenu">
                            <a asp-controller="Factura" asp-action="Index"><i class="fas fa-list"></i>Ver Todos</a>
                            <a asp-controller="Factura" asp-action="AgregarFactura"><i class="fas fa-plus-circle"></i>Agregar Nuevo</a>
                        </div>
                    </div>

                </nav>
            </aside>

            <main class="main-content">

                <header class="topbar d-flex align-items-center justify-content-between px-3 py-2 shadow-sm">
                    <div class="d-flex align-items-center">
                        <button id="toggleSidebar" class="btn btn-link text-dark me-3"><i class="fas fa-bars"></i></button>
                    </div>
                    <div class="d-flex align-items-center">

                        @* Icono Configuracion *@

                        <a href="#" id="settingsToggle" class="me-3" onclick="showModalConfigurarPerfil()">
                            <i class="fas fa-cog"></i>
                        </a>

                        @* Icono tema *@

                        <button id="toggleMode" class="me-3 btn btn-link">
                            <i id="toggleModeIcon" class="fas fa-sun"></i>
                        </button>

                        <div class="dropdown">
                            <a class="dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <img src="@fotoUrl" class="user-profile-menu-configuracion-img me-2" alt="Usuario" />
                            </a>

                            @* Menu Configuracion *@
                            <ul class="dropdown-menu dropdown-menu-end card-postick" aria-labelledby="userDropdown" data-bs-auto-close="outside">
                                <div class="card-postick-header">
                                    <h2>
                                        <img src="@fotoUrl" alt="Usuario" class="user-profile-img me-2">
                                        <b class="brand-title" style="font-size: 1rem;">
                                            @nombreUsuario
                                        </b>
                                    </h2>
                                </div>
                                <li>
                                    <a id="btnMostrarModalConfiguracion" class="dropdown-item brand-title" href="#" onclick="showModalConfigurarPerfil()">
                                        <i class="fas fa-cog me-2"></i>Configuración
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item brand-title" href="/Login/Logout">
                                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesión
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </header>

                <section class="content-body">
                    @RenderBody()
                </section>
            </main>

        </div>
    }
    else
    {
        <script>
            window.location.href = '/Login/Index';
        </script>
    }

    @* Scripts *@
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
    <script src="@Url.Content("~/js/Validacion.js")"></script>
    <script src="@Url.Content("~/js/site.js")"></script>
    <script src="@Url.Content("~/js/General.js")"></script>

    @RenderSection("Scripts", required: false);

    @* Contenedor para vista parcial *@

    <div id="modalContainer"></div>

    @* Modal Configuracion Perfil *@

    <div class="modal fade" id="modalConfigurarPerfil" tabindex="-1" aria-labelledby="modalConfigurarPerfil" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfigurarPerfil">
                        Configuración general
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <div class="form-check form-switch d-flex align-items-center" style="font-size: 0.875rem;">
                        <input class="form-check-input me-3" type="checkbox" id="switchTemaOscuro" style="width: 3rem; height: 1.5rem;">
                        <label class="form-check-label" for="switchTemaOscuro" style="font-size: 0.875rem;">Cambiar a tema oscuro</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
